# Set the workspace environment to the folder containing the rasters
arcpy.env.workspace = r"C:\Users\lilyb\OneDrive\Desktop\visibout"

# Use the ListRasters function to create a list of rasters in the folder
rasters = arcpy.ListRasters()

# Initialize variables to keep track of the maximum count value and the names of the rasters with the maximum count
max_count = -1
max_count_rasters = ""

# Iterate through all possible pairs of rasters
for i in range(len(rasters)):
    for j in range(i+1, len(rasters)):
        # Create a unique filename for the output dataframe
        output_filename = f"{rasters[i]}_{rasters[j]}_table.csv"

        # Perform visibility analysis on the pair of rasters
        outvis = arcpy.sa.Visibility(rasters[i], rasters[j], analysis_type="OBSERVERS", nonvisible_cell_value="NODATA")

        # Get the raster attribute table as a table view
        table_view_name = f"{rasters[i]}_{rasters[j]}_view"
        table_view = arcpy.MakeTableView_management(outvis, table_view_name)

        # Get the Count value from the table view using a SearchCursor
        count_field = "Count"
        with arcpy.da.SearchCursor(table_view, count_field) as cursor:
            count_values = [row[0] for row in cursor]

        # Calculate the total count for the pair of rasters
        count_total = sum(count_values)

        # Check if the total count is greater than the current maximum count value
        if count_total > max_count:
            # If so, update the maximum count value and the names of the rasters with the maximum count value
            max_count = count_total
            max_count_rasters = (rasters[i], rasters[j])

        # Convert the table view to a Pandas dataframe
        dataframe = pd.DataFrame.from_records(arcpy.da.TableToNumPyArray(table_view, count_field))

        # Save the dataframe to a file
        dataframe.to_csv(output_filename, index=False)

        # Print a message indicating the dataframe has been saved
        print(f"{output_filename} saved successfully.")

# Print the names of the rasters with the highest visibility count together
print(f"The pair of rasters with the highest visibility count is {max_count_rasters} with a count of {max_count}")
